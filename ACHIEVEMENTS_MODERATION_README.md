# Система модерации достижений для обычных пользователей

## Описание изменений

Реализована возможность для обычных пользователей с подтверждённой почтой создавать достижения, которые отправляются в статус `pending` для модерации администраторами/модераторами.

## Что изменилось

### Бэкенд (Node.js/Express)

1. **JWT токены**: Добавлено поле `email_verified` в JWT payload
2. **Middleware**: Создан `requireVerifiedEmail` middleware для проверки подтверждённой почты
3. **Маршруты достижений**: Обновлён маршрут создания достижений для работы с обычными пользователями
4. **Модерация**: Добавлены маршруты для модерации достижений (approve/reject)
5. **Пользовательские достижения**: Добавлен маршрут для получения достижений пользователя

### База данных

1. **Миграция**: Обновлена миграция `migrate-moderation-periods-achievements.ts` для добавления недостающих полей
2. **Поля**: Добавлены поля `created_at`, `updated_at`, `submitted_at`, `reviewed_at`, `reviewed_by`, `review_comment`
3. **Индексы**: Добавлены индексы для полей модерации
4. **Внешние ключи**: Добавлены внешние ключи для связи с пользователями

### Фронтенд (React)

1. **API функции**: Добавлены функции для работы с достижениями пользователя и модерации
2. **UI компоненты**: Обновлены компоненты для работы с обычными пользователями
3. **Проверки**: Заменены проверки на модератора на проверки подтверждённой почты

## Развёртывание

### 1. Запуск миграции базы данных

```bash
cd src/db
npm run migrate:moderation
```

Или вручную:

```bash
cd src/db
npx ts-node migrate-moderation-periods-achievements.ts
```

### 2. Перезапуск бэкенда

```bash
npm run build
npm start
```

### 3. Перезапуск фронтенда

```bash
cd ../chronoline-frontend
npm start
```

## Как это работает

### Для обычных пользователей

1. **Регистрация**: Пользователь регистрируется и получает роль `user`
2. **Подтверждение email**: Пользователь подтверждает email
3. **Создание достижений**: Пользователь может создавать достижения через интерфейс
4. **Статус**: Достижения создаются в статусе `pending`
5. **Уведомления**: Пользователь получает уведомление о том, что достижение отправлено на модерацию

### Для модераторов/администраторов

1. **Просмотр pending**: Модераторы видят все достижения в статусе `pending`
2. **Модерация**: Могут одобрить (`approve`) или отклонить (`reject`) достижения
3. **Комментарии**: Могут оставлять комментарии при отклонении
4. **Автоматическое одобрение**: Достижения от модераторов/администраторов создаются сразу в статусе `approved`

## API маршруты

### Создание достижения
- `POST /api/persons/:id/achievements` - Создание достижения для личности
- Требует: аутентификация + подтверждённая почта

### Модерация (только для модераторов)
- `GET /api/admin/achievements/pending` - Получение pending достижений
- `POST /api/admin/achievements/:id/review` - Одобрение/отклонение достижения

### Пользовательские достижения
- `GET /api/achievements/mine` - Получение достижений пользователя
- Требует: аутентификация

### Публичные маршруты
- `GET /api/achievements` - Список одобренных достижений
- `GET /api/persons/:id/achievements` - Достижения личности (только одобренные)

## Безопасность

1. **JWT токены**: Включают информацию о подтверждённой почте
2. **Middleware**: Проверка подтверждённой почты перед созданием достижений
3. **Роли**: Модерация доступна только модераторам и администраторам
4. **Валидация**: Все данные валидируются на бэкенде

## Тестирование

### Тест создания достижения обычным пользователем

1. Зарегистрируйтесь как обычный пользователь
2. Подтвердите email
3. Попробуйте создать достижение для существующей личности
4. Проверьте, что достижение создалось в статусе `pending`

### Тест модерации

1. Войдите как модератор/администратор
2. Перейдите в раздел достижений
3. Найдите pending достижения
4. Попробуйте одобрить или отклонить достижение

## Возможные проблемы

1. **Поле status отсутствует**: Убедитесь, что миграция выполнена успешно
2. **JWT не содержит email_verified**: Проверьте, что пользователь подтвердил email
3. **Ошибки внешних ключей**: Проверьте, что таблица users существует и содержит нужные записи

## Дальнейшее развитие

1. **Уведомления**: Email уведомления о статусе модерации
2. **Автоматическая модерация**: Правила для автоматического одобрения
3. **История изменений**: Логирование всех изменений статуса
4. **Массовая модерация**: Возможность модерации нескольких достижений одновременно
