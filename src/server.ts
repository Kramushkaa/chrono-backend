import express from 'express';
import cors from 'cors';
import { Pool } from 'pg';
import { AuthService } from './services/authService';
import { AuthController } from './controllers/authController';
import { createAuthRoutes } from './routes/authRoutes';
import { logRequest, errorHandler } from './middleware/auth';

// ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
const pool = new Pool({
  user: process.env.DB_USER || 'postgres',
  host: process.env.DB_HOST || 'localhost',
  database: process.env.DB_NAME || 'chrononinja',
  password: process.env.DB_PASSWORD || 'password',
  port: parseInt(process.env.DB_PORT || '5432'),
});

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² Ð¸ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ð¾Ð²
const authService = new AuthService(pool);
const authController = new AuthController(authService);

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Express Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
const app = express();
const PORT = process.env.PORT || 3001;

// Middleware
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(cors({
  origin: process.env.CORS_ORIGIN || '*',
  credentials: true
}));

// Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
app.use(logRequest);

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
app.use('/api/auth', createAuthRoutes(authController));

// ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ API
app.get('/api/health', (req, res) => {
  res.json({
    success: true,
    message: 'Ð¥Ñ€Ð¾Ð½Ð¾ Ð½Ð¸Ð½Ð´Ð·Ñ API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚',
    timestamp: new Date().toISOString(),
    version: '1.0.0'
  });
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑÑ…
app.get('/api/persons', async (req, res) => {
  try {
    const query = `
      SELECT 
        id, 
        name, 
        birth_year, 
        death_year, 
        category, 
        description, 
        achievements,
        country,
        image_url
      FROM historical_persons 
      ORDER BY birth_year ASC
    `;
    
    const result = await pool.query(query);
    
    res.json({
      success: true,
      data: result.rows
    });
  } catch (error) {
    console.error('Error fetching persons:', error);
    res.status(500).json({
      success: false,
      error: 'Database error',
      message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…'
    });
  }
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¹ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸
app.get('/api/persons/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const query = `
      SELECT 
        id, 
        name, 
        birth_year, 
        death_year, 
        category, 
        description, 
        achievements,
        country,
        image_url
      FROM historical_persons 
      WHERE id = $1
    `;
    
    const result = await pool.query(query, [id]);
    
    if (result.rows.length === 0) {
      res.status(404).json({
        success: false,
        error: 'Person not found',
        message: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°'
      });
      return;
    }
    
    res.json({
      success: true,
      data: result.rows[0]
    });
  } catch (error) {
    console.error('Error fetching person:', error);
    res.status(500).json({
      success: false,
      error: 'Database error',
      message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…'
    });
  }
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹
app.get('/api/categories', async (req, res) => {
  try {
    const query = `
      SELECT DISTINCT category 
      FROM historical_persons 
      WHERE category IS NOT NULL 
      ORDER BY category
    `;
    
    const result = await pool.query(query);
    
    res.json({
      success: true,
      data: result.rows.map(row => row.category)
    });
  } catch (error) {
    console.error('Error fetching categories:', error);
    res.status(500).json({
      success: false,
      error: 'Database error',
      message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹'
    });
  }
});

// ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ‚Ñ€Ð°Ð½
app.get('/api/countries', async (req, res) => {
  try {
    const query = `
      SELECT DISTINCT country 
      FROM historical_persons 
      WHERE country IS NOT NULL 
      ORDER BY country
    `;
    
    const result = await pool.query(query);
    
    res.json({
      success: true,
      data: result.rows.map(row => row.country)
    });
  } catch (error) {
    console.error('Error fetching countries:', error);
    res.status(500).json({
      success: false,
      error: 'Database error',
      message: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½'
    });
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
app.use(errorHandler);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° 404
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Not found',
    message: 'ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½'
  });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(PORT, () => {
  console.log(`ðŸš€ Ð¥Ñ€Ð¾Ð½Ð¾ Ð½Ð¸Ð½Ð´Ð·Ñ API ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸ“Š Health check: http://localhost:${PORT}/api/health`);
  console.log(`ðŸ” Auth API: http://localhost:${PORT}/api/auth`);
  console.log(`ðŸ‘¥ Persons API: http://localhost:${PORT}/api/persons`);
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM received, shutting down gracefully');
  pool.end();
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('SIGINT received, shutting down gracefully');
  pool.end();
  process.exit(0);
});

export default app; 